#!/usr/bin/env php
<?php

declare(strict_types=1);

use Climb\Grades\Domain\Value\Grade;
use Climb\Grades\Domain\Value\GradeSystem;
use Climb\Grades\Infrastructure\Config\GradeServices;

require __DIR__ . '/../vendor/autoload.php';

$argv = $_SERVER['argv'];
$argc = $_SERVER['argc'];

$help = <<<TXT
Usage:
  php bin/grades <gradeValue> <gradeSystem> [<targetSystem>] [--include-source]

Examples:
  php bin/grades 6c+ FR             # convert to all other systems (lists)
  php bin/grades 6c+ FR --include-source
  php bin/grades 6c+ FR YDS         # convert only to YDS (list)
TXT;

if ($argc < 3) {
    fwrite(STDERR, $help . PHP_EOL);
    exit(1);
}

$value   = $argv[1];                    // e.g. "6c+"
$system  = strtoupper($argv[2]);        // e.g. "FR"
$target  = null;
$include = false;

// parse optional args
for ($i = 3; $i < $argc; $i++) {
    $arg = $argv[$i];
    if ($arg === '--include-source') {
        $include = true;
        continue;
    }
    // if not a flag, treat as target system
    if ($target === null) {
        $target = strtoupper($arg);
    }
}

try {
    $service = GradeServices::conversion();
    $grade   = new Grade($value, $system);

    if ($target !== null) {
        // one target → print ALL variants
        $targetEnum = GradeSystem::from($target);
        $list = $service->convert($grade, $targetEnum); // Grade[]

        echo "{$value} {$system} -> {$targetEnum->value}:" . PHP_EOL;
        if (empty($list)) {
            echo "- (no results)" . PHP_EOL;
            exit(0);
        }
        foreach ($list as $g) {
            echo "- {$g->value()}" . PHP_EOL;
        }
        exit(0);
    }

    // all systems → each key maps to a LIST
    $all = $service->convertToAll($grade, $include);

    echo "Conversions for {$value} {$system}:" . PHP_EOL;
    if (empty($all)) {
        echo "- (no results)" . PHP_EOL;
        exit(0);
    }

    foreach ($all as $sys => $grades) {
        if (empty($grades)) {
            echo "- {$sys}: (no results)" . PHP_EOL;
            continue;
        }
        $vals = array_map(static fn($g) => $g->value(), $grades);
        echo "- {$sys}: " . implode(', ', $vals) . PHP_EOL;
    }
} catch (ValueError $e) {
    // GradeSystem::from() throws ValueError on invalid enum
    fwrite(STDERR, "Unknown system provided. {$help}" . PHP_EOL);
    exit(1);
} catch (Throwable $e) {
    fwrite(STDERR, '[error] ' . $e->getMessage() . PHP_EOL);
    exit(1);
}
